# Sync Khronos Swagger Spec
# Automatically fetches the latest Khronos swagger spec from the Khronos repo.
# The OpenAPI client is generated at build/deploy time, not committed to the repo.
#
# Triggers:
#   - repository_dispatch from Khronos CI (on every Khronos push to main)
#   - workflow_dispatch for manual sync

name: Sync Khronos Spec

on:
  repository_dispatch:
    types: [ khronos-spec-updated ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-spec:
    name: Sync Swagger Spec
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch latest Khronos spec
        id: fetch
        env:
          KHRONOS_PAT: ${{ secrets.KHRONOS_PAT }}
        run: |
          set -euo pipefail

          SPEC_URL="https://raw.githubusercontent.com/fearandesire/khronos/main/spec/khronos-swagger-spec-v1.json"
          SPEC_FILE="spec/khronos-swagger-spec-v1.json"
          TEMP_SPEC="/tmp/khronos-swagger-spec-v1.json"

          echo "ðŸ“¥ Fetching spec from: $SPEC_URL"
          curl -sSL -H "Authorization: token $KHRONOS_PAT" "$SPEC_URL" -o "$TEMP_SPEC"

          # Calculate hashes
          if [ -f "$SPEC_FILE" ]; then
            OLD_HASH=$(sha256sum "$SPEC_FILE" | cut -d' ' -f1)
            echo "old_hash=$OLD_HASH" >> $GITHUB_OUTPUT
          else
            echo "old_hash=none" >> $GITHUB_OUTPUT
          fi

          NEW_HASH=$(sha256sum "$TEMP_SPEC" | cut -d' ' -f1)
          echo "new_hash=$NEW_HASH" >> $GITHUB_OUTPUT

          # Move new spec into place
          mkdir -p spec
          mv "$TEMP_SPEC" "$SPEC_FILE"

          # Check if changed
          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Spec changed (old: ${OLD_HASH:0:8}, new: ${NEW_HASH:0:8})"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Spec unchanged (hash: ${NEW_HASH:0:8})"
          fi

      - name: Configure Git
        if: steps.fetch.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        if: steps.fetch.outputs.changed == 'true'
        run: |
          set -euo pipefail

          git add spec/khronos-swagger-spec-v1.json

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi

          SPEC_HASH="${{ steps.fetch.outputs.new_hash }}"
          COMMIT_MSG="chore: sync Khronos swagger spec [${SPEC_HASH:0:8}]"

          git commit -m "$COMMIT_MSG"
          git push origin main

          echo "âœ… Spec committed and pushed to main"

      - name: Create sync summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ”„ Swagger Spec Sync Summary

          | Property | Value |
          |----------|-------|
          | **Trigger** | `${{ github.event_name }}` |
          | **Old Hash** | `${{ steps.fetch.outputs.old_hash }}` |
          | **New Hash** | `${{ steps.fetch.outputs.new_hash }}` |
          | **Changed** | `${{ steps.fetch.outputs.changed }}` |
          | **Status** | ${{ steps.fetch.outputs.changed == 'true' && 'âœ… Updated' || 'â„¹ï¸ No changes' }} |
          EOF
