# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                        PLUTO BETTING APP - CI/CD PIPELINE                     â•‘
# â•‘                                                                              â•‘
# â•‘  Builds, tests, and deploys Docker images to GitHub Container Registry.      â•‘
# â•‘  Version derived from package.json / .release-please-manifest.json           â•‘
# â•‘                                                                              â•‘
# â•‘  COMMIT MESSAGE TRIGGERS:                                                   â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
# â•‘  â”‚ Pattern                              â”‚ Action                           â”‚ â•‘
# â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
# â•‘  â”‚ 'chore(main): release X.Y.Z'         â”‚ Deploy (automated release)       â”‚ â•‘
# â•‘  â”‚ 'fix:', 'fix(scope):'                â”‚ Deploy (emergency fix)           â”‚ â•‘
# â•‘  â”‚ 'patch:', 'hotfix:'                  â”‚ Deploy (emergency patch)         â”‚ â•‘
# â•‘  â”‚ '--force-build'                      â”‚ Deploy (force flag)              â”‚ â•‘
# â•‘  â”‚ '--skip-ci'                          â”‚ Skip entire workflow             â”‚ â•‘
# â•‘  â”‚ '--skip-tests'                       â”‚ Skip test phase only             â”‚ â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
# â•‘                                                                              â•‘
# â•‘  DOCUMENTATION: Changes to .md, docs/, LICENSE, etc. are ignored.           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build and push (bypasses branch/event conditions)"
        type: boolean
        default: false
      skip_tests:
        description: "Skip test phase entirely"
        type: boolean
        default: false
      version_override:
        description: "Override version (e.g., 1.0.0-beta.1)"
        type: string
        required: false
      pre_release_suffix:
        description: "Pre-release suffix (e.g., beta, rc, alpha)"
        type: string
        required: false

  # Push events trigger CI/CD for code changes
  push:
    branches: [main]
    paths-ignore:
      # Documentation changes are ignored - they don't trigger deployments
      - "**.md"
      - "docs/**"
      - "dev/**"
      - ".github/*.md"
      - "LICENSE"
      - ".gitignore"
      - "!.github/workflows/**" # exec on workflow changes

  # PRs run verification but don't deploy
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "dev/**"

  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: pluto-betting-bot
  IMAGE_TITLE: Pluto Betting Bot
  IMAGE_DESCRIPTION: "Sports Betting Application for Discord"
  IMAGE_VENDOR: fearandesire

permissions:
  contents: read
  pull-requests: read
  packages: write

jobs:
  # ============================================================================
  # VERIFICATION PHASE - Lint, Build, Commit Validation
  # ============================================================================
  # This job runs on every push/PR to validate code quality and conventional commits
  # Skips for dependabot and when '--skip-ci' is in commit message
  check:
    name: Verification
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.actor != 'dependabot[bot]' &&
        !contains(github.event.head_commit.message, '--skip-ci') &&
        !(github.event_name == 'workflow_dispatch' && inputs.skip_tests == true)
      }}

    env:
      SKIP_TESTS: ${{ contains(github.event.head_commit.message, '--skip-tests') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git operations (commit validation)

      # Setup Node.js environment with pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Verify code compiles without errors
      - name: Build
        run: pnpm build

      # Ensure commit messages follow conventional commit format
      # This validates PRs and pushes for proper commit message structure
      - name: Validate commit messages (conventional commits)
        if: github.event_name == 'pull_request' || github.event_name == 'push'
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            npx commitlint --from ${{ github.event.pull_request.base.sha }} --to HEAD --verbose
          else
            FROM_SHA="${{ github.event.before }}"
            if ! git cat-file -e "$FROM_SHA" 2>/dev/null; then
              echo "Commit $FROM_SHA not found (likely due to rebase), using origin/main as base"
              git fetch origin main 2>/dev/null || true
              MERGE_BASE=$(git merge-base HEAD origin/main 2>/dev/null || echo "origin/main")
              FROM_SHA="$MERGE_BASE"
            fi
            npx commitlint --from "$FROM_SHA" --to HEAD --verbose
          fi

  # ============================================================================
  # BUILD AND PUSH - Build Docker image and push to GHCR
  # ============================================================================
  # This job only runs after verification passes and meets deployment criteria
  # Deploys to GitHub Container Registry with version tags
  docker:
    name: Build and Push Docker Image
    needs: check # Must pass verification first
    runs-on: ubuntu-latest
    # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    # â”‚ DEPLOYMENT TRIGGERS (any of these will deploy):                        â”‚
    # â”‚ â€¢ 'chore(main): release X.Y.Z' â†’ Automated release                      â”‚
    # â”‚ â€¢ '--force-build' â†’ Force deployment flag                               â”‚
    # â”‚ â€¢ 'fix:', 'fix(scope):', 'patch:', 'hotfix:' â†’ Emergency fixes         â”‚
    # â”‚ â€¢ Manual workflow_dispatch with force_build=true                        â”‚
    # â”‚ â€¢ GitHub release published                                              â”‚
    # â”‚                                                                         â”‚
    # â”‚ WHAT WON'T DEPLOY:                                                     â”‚
    # â”‚ â€¢ Documentation changes (.md, docs/, LICENSE, etc.)                    â”‚
    # â”‚ â€¢ Regular feature commits without special patterns                      â”‚
    # â”‚ â€¢ Any changes that fail the 'check' job                                 â”‚
    # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    if: |
      always() &&
      needs.check.result == 'success' &&
      (
        (github.event_name == 'push' && github.ref == 'refs/heads/main' && (
          startsWith(github.event.head_commit.message, 'chore(main): release') ||
          contains(github.event.head_commit.message, '--force-build') ||
          startsWith(github.event.head_commit.message, 'fix:') ||
          startsWith(github.event.head_commit.message, 'fix(') ||
          startsWith(github.event.head_commit.message, 'patch:') ||
          startsWith(github.event.head_commit.message, 'hotfix:')
        )) ||
        (github.event_name == 'workflow_dispatch' && inputs.force_build == true) ||
        github.event_name == 'release'
      )

    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      image_tag: ${{ steps.version.outputs.image_tag }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git tag inspection and version detection

      # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      # â”‚ VERSION RESOLUTION (in order of precedence):                            â”‚
      # â”‚ 1. workflow_dispatch version_override input (manual override)          â”‚
      # â”‚ 2. package.json version field (standard Node.js versioning)            â”‚
      # â”‚ 3. .release-please-manifest.json version (automated releases)          â”‚
      # â”‚ 4. Latest git tag (vX.Y.Z or X.Y.Z format) fallback                     â”‚
      # â”‚ 5. Fallback: 0.0.0 (if no version found anywhere)                      â”‚
      # â”‚                                                                         â”‚
      # â”‚ PRE-RELEASE DETECTION:                                                  â”‚
      # â”‚ - Checks for open release-please PRs to create beta versions           â”‚
      # â”‚ - Applies manual pre_release_suffix if provided                        â”‚
      # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      - name: Resolve version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION_OVERRIDE: ${{ inputs.version_override || '' }}
          PRERELEASE_SUFFIX: ${{ inputs.pre_release_suffix || '' }}
        run: |
          set -euo pipefail

          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IS_PRERELEASE="false"
          VERSION=""

          # 1. Check for manual override
          if [[ -n "${VERSION_OVERRIDE}" ]]; then
            VERSION="${VERSION_OVERRIDE}"
            echo "ðŸ“¦ Version source: manual override"
          fi

          # 2. Try package.json
          if [[ -z "${VERSION}" ]] && [[ -f "package.json" ]]; then
            VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "")
            if [[ -n "${VERSION}" ]]; then
              echo "ðŸ“¦ Version source: package.json"
            fi
          fi

          # 3. Try release-please manifest
          if [[ -z "${VERSION}" ]] && [[ -f ".release-please-manifest.json" ]]; then
            VERSION=$(node -p "Object.values(require('./.release-please-manifest.json'))[0]" 2>/dev/null || echo "")
            if [[ -n "${VERSION}" ]]; then
              echo "ðŸ“¦ Version source: .release-please-manifest.json"
            fi
          fi

          # 4. Try git tags
          if [[ -z "${VERSION}" ]]; then
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "")
            if [[ -n "${VERSION}" ]]; then
              echo "ðŸ“¦ Version source: git tag"
            fi
          fi

          # 5. Fallback
          if [[ -z "${VERSION}" ]]; then
            VERSION="0.0.0"
            echo "ðŸ“¦ Version source: fallback (no version found)"
          fi

          # Check for release-please PR to determine pre-release status
          if [[ -z "${VERSION_OVERRIDE}" ]]; then
            RELEASE_PR=$(gh pr list --state open --label "autorelease: pending" --json number,title --jq '.[0].title' 2>/dev/null || echo "")
            if [[ -n "${RELEASE_PR}" ]]; then
              NEXT_VERSION=$(echo "${RELEASE_PR}" | grep -oP '\d+\.\d+\.\d+' | head -1 || echo "")
              if [[ -n "${NEXT_VERSION}" ]]; then
                if [[ -n "${PRERELEASE_SUFFIX}" ]]; then
                  VERSION="${NEXT_VERSION}-${PRERELEASE_SUFFIX}"
                else
                  VERSION="${NEXT_VERSION}-beta"
                fi
                IS_PRERELEASE="true"
                echo "ðŸš§ Pre-release detected from release-please PR"
              fi
            fi
          fi

          # Apply manual pre-release suffix if provided
          if [[ "${IS_PRERELEASE}" == "false" ]] && [[ -n "${PRERELEASE_SUFFIX}" ]]; then
            VERSION="${VERSION}-${PRERELEASE_SUFFIX}"
            IS_PRERELEASE="true"
          fi

          IMAGE_TAG="${VERSION}-${SHORT_SHA}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ Version:      ${VERSION}"
          echo "ðŸ”– Short SHA:    ${SHORT_SHA}"
          echo "ðŸ·ï¸  Image Tag:    ${IMAGE_TAG}"
          echo "ðŸš§ Pre-release:  ${IS_PRERELEASE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Setup Docker build environment with Buildx for advanced features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Authenticate with GitHub Container Registry (GHCR)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Downcase image name for Docker image naming (must be lowercase)
      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      # Generate OCI-compliant metadata labels for the Docker image
      # This creates standardized labels for image discovery and compliance
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.image_tag }}  # Version + SHA (unique)
            type=raw,value=${{ steps.version.outputs.version }}    # Clean version
            type=raw,value=${{ steps.version.outputs.short_sha }}  # Commit SHA
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}  # Latest on main
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_TITLE }}
            org.opencontainers.image.description=${{ env.IMAGE_DESCRIPTION }}
            org.opencontainers.image.vendor=${{ env.IMAGE_VENDOR }}
            org.opencontainers.image.version=${{ steps.version.outputs.version }}

      # Build multi-platform Docker image and push to GHCR
      # Includes security scanning (SBOM) and provenance attestation
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }} # Multiple tags from metadata action
          labels: ${{ steps.meta.outputs.labels }} # OCI-compliant labels
          cache-from: type=gha # Use GitHub Actions cache for faster builds
          cache-to: type=gha,mode=max
          provenance: true # Generate build provenance attestation
          sbom: true # Generate Software Bill of Materials

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Deployment Summary

          ### Image Details
          | Property | Value |
          |----------|-------|
          | **Registry** | `${{ env.REGISTRY }}` |
          | **Image** | `${{ github.repository_owner }}/${{ env.IMAGE_NAME }}` |
          | **Version** | `${{ steps.version.outputs.version }}` |
          | **Commit** | `${{ steps.version.outputs.short_sha }}` |
          | **Pre-release** | `${{ steps.version.outputs.is_prerelease }}` |

          ### Published Tags
          ```
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.short_sha }}
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.image_tag }}
          ```

          ### Quick Pull
          ```bash
          docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          ```
          EOF
